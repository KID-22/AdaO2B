# AdaO2B
This is the implementation of AAAI 2025 paper "AdaO2B: Adaptive Online to Batch Conversion for Out-of-Distribution Generalization".

## Abstract
Online to batch conversion involves constructing a new batch learner by utilizing a series of models generated by an existing online learning algorithm, for achieving generalization guarantees under i.i.d assumption. However, when applied to real-world streaming applications such as streaming recommender systems, the data stream may be sampled from time-varying distributions instead of persistently being i.i.d. This poses a challenge in terms of out-of-distribution (OOD) generalization. Existing approaches employ fixed conversion mechanisms that are unable to adapt to novel testing distributions, hindering the testing accuracy of the batch learner. To address these issues, we propose AdaO2B, an adaptive online to batch conversion approach under the bandit setting. AdaO2B is designed to be aware of the distribution shifts in the testing data and achieves OOD generalization guarantees. Specifically, AdaO2B can dynamically combine the sequence of models learned by a contextual bandit algorithm and determine appropriate combination weights using a context-aware weighting function. This innovative approach allows for the conversion of a sequence of models into a batch learner that facilitates OOD generalization. Theoretical analysis provides justification for why and how the learned adaptive batch learner can achieve OOD generalization error guarantees. Experimental results have demonstrated that AdaO2B significantly outperforms state-of-the-art baselines on both synthetic and real-world recommendation datasets.

## File Structure

```shell
├── Real_KuaiRec  # * reproduce for real-world dataset KuaiRec
└── Synthetic  # * reproduce for the synthetic dataset
```

## Usage Example
For reproducing the results for the synthetic dataset, you can run the following scripts:
```shell
python ../online.py --model=SBUCB \
--ckpt_save_name="1_final" \
--data_index=1 \
--res_name="1_final" \
>../Log/SBUCB/"online_1_final".log 2>&1

python ../online.py --model=SBUCB \
--ckpt_save_name="2_final" \
--data_index=2 \
--res_name="2_final" \
>../Log/SBUCB/"online_2_final".log 2>&1

python ../online.py --model=SBUCB \
--ckpt_load_name="1_final" \
--ckpt_save_name="1+2_final" \
--data_index=2 \
--res_name="1+2_final" \
>../Log/SBUCB/"online_1+2_final".log 2>&1

python ../batch.py --model=SBUCB \
--base_model_save_name="1101_1_final" \
--ckpt_load_name="1_final" \
--data_index=2 \
--res_name="1to2_final" \
>../Log/SBUCB/"batch_1to2_final".log 2>&1

for data_selection in S D
do
    for j in {5..20..5}
    do
        if [ ${data_selection} == S ]
        then
            batch_size=512
            lr=0.01
            weight_decay=1e-5
        elif [ ${data_selection} == R ]
        then
            batch_size=512
            lr=0.01
            weight_decay=1e-4
        elif [ ${data_selection} == D ]
        then
            batch_size=1024
            lr=0.01
            weight_decay=1e-5
        fi

        python ../main_adao2b.py \
        --base_model=SBUCB \
        --K=${j} \
        --batch_size=${batch_size} \
        --lr=${lr} \
        --weight_decay=${weight_decay} \
        --base_model_save_name="1_final" \
        --history_data_name="1_final" \
        --adao2b_ckpt_name="adao2b_SBUCB_final"${data_selection}"_K"${j}"" \
        --data_selection=${data_selection} \
        >../Log/AdaO2B/""${data_selection}"_adao2b_SBUCB_final_K"${j}"".log 2>&1

        python ../batch.py --model=SBUCB \
        --K=${j} \
        --base_model_save_name="1_final" \
        --adao2b_ckpt_name="adao2b_SBUCB_final"${data_selection}"_K"${j}"" \
        --adao2b=1 \
        --data_index=2 \
        --res_name="AdaO2B_final"${data_selection}"_K"${j}"" \
        --data_selection=${data_selection} \
        >../Log/AdaO2B/""${data_selection}"_adao2b_SBUCB_batch_test_final_K"${j}"".log 2>&1
    done
done
```